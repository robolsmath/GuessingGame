<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Robols | Games</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Clear Sans', 'Helvetica Neue', Arial, sans-serif;
            background-color: #121213;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            border-bottom: 1px solid #3a3a3c;
            width: 100%;
            max-width: 500px;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .version-text {
            position: absolute;
            right: 20px;
            bottom: -20px;
            font-size: 15px;
            color: #565758;
        }

        h1 {
            text-align: center;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 0.2rem;
        }

        

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }

        .guesses-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        .guesses-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        @media (max-width: 768px) {
            .guesses-container {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        .guess-row {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .feedback {
            margin-left: 15px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 14px;
            font-weight: bold;
            min-width: 80px;
        }

        .feedback-left {
            margin-right: 15px;
            align-items: flex-end;
        }

        .feedback-right {
            margin-left: 15px;
            align-items: flex-start;
        }

        .feedback-correct {
            color: #538d4e;
        }

        .feedback-present {
            color: #b59f3b;
        }

        .digit-box {
            width: 62px;
            height: 62px;
            border: 2px solid #3a3a3c;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            background-color: #121213;
            transition: all 0.3s;
        }

        .digit-box.filled {
            border-color: #565758;
        }

        .digit-box.active {
            border-color: #565758;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .digit-box.correct {
            background-color: #538d4e;
            border-color: #538d4e;
        }

        .digit-box.present {
            background-color: #b59f3b;
            border-color: #b59f3b;
        }

        .digit-box.codebreaker-filled {
            background-color: #3a3a3c;
            border-color: #565758;
        }

        .digit-box.flip {
            animation: flip 0.5s;
        }

        @keyframes flip {
            0% { transform: rotateX(0); }
            50% { transform: rotateX(90deg); }
            100% { transform: rotateX(0); }
        }

        .button-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 20px;
            /* max-width: 450px; */
            /* margin-top: 20px;
            display: flex;
            justify-content: center; */
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            background-color: #818384;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #9a9b9c;
        }

        button:disabled {
            background-color: #3a3a3c;
            cursor: not-allowed;
        }

        .message {
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
            min-height: 30px;
        }

        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #121213;
            padding: 40px;
            border-radius: 8px;
            border: 1px solid #3a3a3c;
            max-width: 400px;
            width: 90%;
        }

        .modal h2 {
            margin-bottom: 25px;
            text-align: center;
        }

        .modal-option {
            margin-bottom: 20px;
        }

        .modal-option label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #d7dadc;
        }

        .modal-option select,
        .modal-option input[type="number"],
        .modal-option input[type="text"] {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background-color: #121213;
            border: 2px solid #3a3a3c;
            color: #ffffff;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .modal-buttons button {
            flex: 1;
            background-color: #538d4e;
        }

        .stats {
            text-align: center;
            color: #d7dadc;
            margin-top: 10px;
        }

        .history-section {
            margin-top: 30px;
            width: 100%;
            max-width: 500px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3a3a3c;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-header h2 {
            font-size: 20px;
            color: #d7dadc;
        }

        .history-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-btn {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #818384;
        }

        .history-btn:hover {
            background-color: #9a9b9c;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background-color: #1a1a1b;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #3a3a3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-player {
            font-weight: bold;
            color: #ffffff;
            font-size: 16px;
        }

        .history-details {
            font-size: 14px;
            color: #818384;
        }

        .history-attempts {
            font-size: 24px;
            font-weight: bold;
            color: #538d4e;
        }

        .no-history {
            text-align: center;
            color: #818384;
            padding: 20px;
            font-style: italic;
        }

        .history-list::-webkit-scrollbar {
            width: 8px;
        }

        .history-list::-webkit-scrollbar-track {
            background: #1a1a1b;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: #3a3a3c;
            border-radius: 4px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: #565758;
        }

        .new-game-btn {
            background-color: #818384;
            margin-top: 10px;
        }

        .new-game-btn:hover {
            background-color: #538d4e;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-top: 20px;
            max-width: 450px;
        }

        .key {
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            background-color: #818384;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .key:hover {
            background-color: #9a9b9c;
        }

        .key.backspace {
            grid-column: span 2;
            font-size: 16px;
            background-color: #8D4E53;
        }

        .key.enter {
            grid-column: span 2;
            font-size: 16px;
            background-color: #538d4e;
        }

        .key.enter:hover {
            background-color: #6aaa64;
        }

        .key:active {
            opacity: 0.5;
        }

        * {
        touch-action: manipulation;
        }

        .zoom-control {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }

        .zoom-control label {
            color: #d7dadc;
            font-size: 14px;
            min-width: 60px;
        }

        .zoom-slider {
            flex: 1;
            height: 6px;
            background: #3a3a3c;
            border-radius: 3px;
            outline: none;
            /* -webkit-appearance: none; */
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #538d4e;
            cursor: pointer;
            border-radius: 50%;
        }

        .zoom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #538d4e;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .zoom-value {
            color: #d7dadc;
            font-size: 14px;
            min-width: 40px;
        }
        
        .leaderboard-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .leaderboard-content {
            background-color: #121213;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #3a3a3c;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .leaderboard-content h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #d7dadc;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            background-color: #1a1a1b;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #3a3a3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-rank {
            font-size: 20px;
            font-weight: bold;
            color: #818384;
            min-width: 40px;
        }

        .leaderboard-item:nth-child(1) .leaderboard-rank {
            color: #FFD700;
        }

        .leaderboard-item:nth-child(2) .leaderboard-rank {
            color: #C0C0C0;
        }

        .leaderboard-item:nth-child(3) .leaderboard-rank {
            color: #CD7F32;
        }

        .leaderboard-info {
            flex: 1;
            margin-left: 15px;
        }

        .leaderboard-player {
            font-weight: bold;
            color: #ffffff;
            font-size: 16px;
        }

        .leaderboard-details {
            font-size: 14px;
            color: #818384;
            margin-top: 3px;
        }

        .leaderboard-score {
            font-size: 18px;
            font-weight: bold;
            color: #538d4e;
        }

        .close-leaderboard {
            background-color: #818384;
            margin-top: 20px;
            width: 100%;
        }

        .help-icon {
            position: absolute;
            right: 0px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border: 2px solid #d7dadc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #d7dadc;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .help-icon:hover {
            background-color: #d7dadc;
            color: #121213;
        }

        header {
            border-bottom: 1px solid #3a3a3c;
            width: 100%;
            max-width: 500px;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
        }

        .help-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .help-content {
            background-color: #121213;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #3a3a3c;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #d7dadc;
        }

        .help-content h2 {
            margin-bottom: 15px;
            color: #ffffff;
        }

        .help-content h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #ffffff;
            font-size: 18px;
        }

        .help-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .help-example {
            display: flex;
            gap: 5px;
            margin: 15px 0;
        }

        .help-box {
            width: 40px;
            height: 40px;
            border: 2px solid #3a3a3c;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .help-box.correct {
            background-color: #538d4e;
            border-color: #538d4e;
        }

        .help-box.present {
            background-color: #b59f3b;
            border-color: #b59f3b;
        }

        .help-box.absent {
            background-color: #3a3a3c;
            border-color: #3a3a3c;
        }

        .close-help {
            background-color: #818384;
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .close-help:hover {
            background-color: #9a9b9c;
        }

    </style>
    
</head>
<body>
    <header>
        <h1>GUESS THE NUMBER</h1>
        <div class="help-icon" onclick="showHelp()">?</div>
        <div class="version-text" id="versionText"></div>
    </header>

    <div class="game-container">
        <div class="message" id="message"></div>

        <div class="stats">
            <div>Tries: <span id="triesCount">0</span> / <span id="maxTriesDisplay">10</span></div>
            <div class="mode-label" id="modeLabel">Number Wordle</div>
        </div>

        <div class="guesses-container" id="guessesContainer"></div>
        
        <div class="keyboard" id="keyboard"></div>

        <div class="zoom-control">
            <label for="zoomSlider">Zoom:</label>
            <input type="range" id="zoomSlider" class="zoom-slider" min="50" max="150" value="100" step="5">
            <span class="zoom-value" id="zoomValue">100%</span>
        </div>

        <div class="button-container">
            <button class="new-game-btn" onclick="showSettings()">New Game</button>
            <button class="new-game-btn" onclick="showLeaderboard('wordle')">Top Wordlers</button>
            <button class="new-game-btn" onclick="showLeaderboard('codebreaker')">Top CodeBreakers</button>
        </div>

        
    </div>

    <div class="history-section">
        <div class="history-header">
            <h2>Latest Solvers</h2>
        </div>
        <div class="history-list" id="historyList">
            <div class="no-history">No games completed yet</div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Game Settings</h2>
            <div class="modal-option">
                <label for="gameMode">Game Mode:</label>
                <select id="gameMode">
                    <option value="codebreaker">Code Breaker</option>
                    <option value="wordle">Number Wordle</option>
                </select>
            </div>
            <div class="modal-option">
                <label for="playerName">Player Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name" value="">
            </div>
            <div class="modal-option">
                <label for="digitCount">Number of Digits (3-6):</label>
                <input type="number" id="digitCount" min="3" max="6" value="4">
            </div>
            <div class="modal-option">
                <label for="repeatDigits">Allow Repeated Digits:</label>
                <select id="repeatDigits">
                    <option value="yes">YES</option>
                    <option value="no">NO</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button onclick="startGame()">Start Game</button>
            </div>
        </div>
    </div>

    <script>
        let targetNumber = '';
        let guesses = [];
        let allGuesses = []; // Stores all guesses from the current game
        let currentGuess = '';
        let maxTries = 10; // Same for both modes now
        let digitCount = 4;
        let allowRepeats = false;
        let gameOver = false;
        let playerName = '';
        let gameHistory = [];
        let topWordle = [];
        let topCodeBreaker = [];
        let gameMode = 'codebreaker'; // 'wordle' or 'codebreaker'
        let gameStartTime = null;
        let gameEndTime = null;
        let gameScore = 0.0;
        let timeElapsed = 0.0;
        const api_url_latest = 'https://script.google.com/macros/s/AKfycbw5s7F8s1VWRDg1Ldg4Ayk7HsX_cEvnAaf_4QS8UrG_-4bcemfWIb6yiljNcEPj41bdZQ/exec?action=getLatest10"'
        const api_url_top_wordle = 'https://script.google.com/macros/s/AKfycbw5s7F8s1VWRDg1Ldg4Ayk7HsX_cEvnAaf_4QS8UrG_-4bcemfWIb6yiljNcEPj41bdZQ/exec?action=getTopWordle'
        const api_url_top_codebreaker = 'https://script.google.com/macros/s/AKfycbw5s7F8s1VWRDg1Ldg4Ayk7HsX_cEvnAaf_4QS8UrG_-4bcemfWIb6yiljNcEPj41bdZQ/exec?action=getTopCodeBreaker'
        const gameVersion = 'v1.0.4';

        function getScore(T, time, dgts, rpts) {
            // Prevent negative or zero times
            if (time < 0) time = 0;
            const w1 = 1
            const w2 = 1.5
            const timeMin = 120
            const numerator = w1 + w2 * Math.log(1 + timeMin);
            const denominator = w1 * T + w2 * Math.log(1 + time);
            score = 100*dgts/6 * (numerator / denominator);

            if (!rpts){
                score = score/1.2
            }
            console.log('score is ' + String(score))

            return score;
            }

        function showSettings() {
            // Check if game is in progress
            if (!gameOver && guesses.length > 0) {
                if (!confirm('A game is currently in progress. Start a new game?')) {
                    document.getElementById('settingsModal').style.display = 'none';
                    return;
                }
            }
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function loadHistory() {
            // Try to fetch data

            
            // gameHistory
            fetch(api_url_latest)
                .then(response => {
                    if (response.ok) {
                    return response.json();
                    }

                    // If fetch succeeds but no JSON, fallback to localStorage
                    const saved = localStorage.getItem('numbleHistory');
                    return saved ? JSON.parse(saved) : [];
                })
                .then(data => {
                    gameHistory = data;
                    renderHistory();
                })
                .catch(error => {
                    // If fetch fails (offline, network error, CORS), fallback
                    const saved = localStorage.getItem('numbleHistory');
                    if (saved) {
                    gameHistory = JSON.parse(saved);
                    renderHistory();
                    } else {
                    gameHistory = []; // nothing stored
                    renderHistory();
                    }
                });
            
            // topWordle
            fetch(api_url_top_wordle)
                .then(response => {
                    if (response.ok) {
                    return response.json();
                    }
                })
                .then(data => {
                    topWordle = data;
                })
                .catch(error => {
                    topWordle = []; // nothing stored
                });
            
            // topCodebreaker
            fetch(api_url_top_codebreaker)
                .then(response => {
                    if (response.ok) {
                    return response.json();
                    }
                })
                .then(data => {
                    topCodeBreaker = data;
                })
                .catch(error => {
                    topCodeBreaker = []; // nothing stored
                });
        }

        function saveHistory() {
            localStorage.setItem('numbleHistory', JSON.stringify(gameHistory));
            fetch(api_url_latest,{
                      method: 'POST',
                      body: JSON.stringify({name: playerName || 'Anonymous',
                      date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString(),
                        attempts: guesses.length,
                        digitCount: digitCount,
                        allowRepeats: allowRepeats,
                        gameMode: gameMode,
                        maxTries: maxTries,
                        timeElapsed: timeElapsed,
                        gameScore: gameScore
                      })
                })
                .then(r => r.json())
                .then(console.log)
                .catch(console.error);
        }

        function addToHistory(won) {
            if (won) {
                const record = {
                    player: playerName || 'Anonymous',
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    attempts: guesses.length,
                    digitCount: digitCount,
                    allowRepeats: allowRepeats,
                    gameMode: gameMode,
                    maxTries: maxTries,
                    timeElapsed: timeElapsed,
                    gameScore: gameScore
                };
                gameHistory.unshift(record); // Add to beginning


                // Check if this record should be added to topWordle
                if (record.gameMode === 'wordle') {
                    // Check if topWordle has less than 10 records OR if this score beats the lowest score
                    const shouldAddToTop = topWordle.length < 10 || 
                                            record.gameScore > topWordle[topWordle.length - 1].gameScore;
                    
                    if (shouldAddToTop) {
                        // Add the new record
                        topWordle.push(record);
                        
                        // Sort by gameScore descending (highest first)
                        topWordle.sort((a, b) => b.gameScore - a.gameScore);
                        
                        // Keep only top 10
                        if (topWordle.length > 10) {
                            topWordle = topWordle.slice(0, 10);
                        }
                    }
                }

                if (record.gameMode === 'codebreaker') {
                    // Check if topCodebreaker has less than 10 records OR if this score beats the lowest score
                    const shouldAddToTop_codebreaker = topCodeBreaker.length < 10 || 
                                            record.gameScore > topCodeBreaker[topCodeBreaker.length - 1].gameScore;

                    if (shouldAddToTop_codebreaker) {
                        // Add the new record
                        topCodeBreaker.push(record);
                                                
                        // Sort by gameScore descending (highest first)
                        topCodeBreaker.sort((a, b) => b.gameScore - a.gameScore);
                        
                        // Keep only top 10
                        if (topCodeBreaker.length > 10) {
                            topCodeBreaker = topCodeBreaker.slice(0, 10);
                        }
                    }
                }

                saveHistory();
                renderHistory();
            }
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (gameHistory.length === 0) {
                historyList.innerHTML = '<div class="no-history">No games completed yet</div>';
                return;
            }

            historyList.innerHTML = '';
            gameHistory.forEach(record => {
                const minutes = Math.floor(record.timeElapsed / 60);
                const seconds = Math.round(record.timeElapsed % 60);
                const timeDisplay = record.timeElapsed ? ` ‚Ä¢ ${minutes}m ${seconds}s` : '';

                const item = document.createElement('div');
                item.className = 'history-item';
                const modeName = record.gameMode === 'codebreaker' ? 'Code Breaker' : 'Number Wordle';
                const modeLabel = record.gameMode ? `${modeName}` : '';
                item.innerHTML = `
                    <div class="history-item-info">
                        <div class="history-player">${record.player}</div>
                        <div class="history-details">
                            ${modeLabel} ‚Ä¢ ${record.time}, ${record.date} ‚Ä¢ ${record.attempts} attempts ‚Ä¢ ${record.digitCount} digits${record.allowRepeats ? ' (repeats)' : ''} ${timeDisplay}
                        </div>
                    </div>
                    <div class="history-attempts">${record.gameScore.toFixed(1)}</div>
                `;
                historyList.appendChild(item);
            });
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all game history?')) {
                gameHistory = [];
                saveHistory();
                renderHistory();
            }
        }

        function generateNumber() {
            if (allowRepeats) {
                targetNumber = '';
                for (let i = 0; i < digitCount; i++) {
                    targetNumber += Math.floor(Math.random() * 10);
                }
            } else {
                const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                targetNumber = '';
                for (let i = 0; i < digitCount; i++) {
                    const idx = Math.floor(Math.random() * digits.length);
                    targetNumber += digits[idx];
                    digits.splice(idx, 1);
                }
            }
            // console.log('Target number generated (for testing):', targetNumber);
        }

        function startGame() {
            const nameInput = document.getElementById('playerName').value.trim();
            playerName = nameInput || 'Anonymous';
            
            gameMode = document.getElementById('gameMode').value;
            digitCount = parseInt(document.getElementById('digitCount').value);
            allowRepeats = document.getElementById('repeatDigits').value === 'yes';
            
            if (digitCount < 3 || digitCount > 6 || String(digitCount) === "NaN") {
                alert('Please enter a number between 3 and 6');
                return;
            }
            
            maxTries = (gameMode === "wordle") ? 10 : 12;
            
            document.getElementById('settingsModal').style.display = 'none';
            
            guesses = [];
            allGuesses = []; // Reset guesses for new game
            currentGuess = '';
            gameOver = false;
            generateNumber();
            
            // Clear the board container for fresh start
            document.getElementById('guessesContainer').innerHTML = '';
            
            renderBoard();
            renderKeyboard();
            updateStats();
            document.getElementById('message').textContent = '';
            
            // Update mode label
            const modeName = gameMode === 'codebreaker' ? 'Code Breaker' : 'Number Wordle';
            document.getElementById('modeLabel').textContent = modeName;
            document.getElementById('maxTriesDisplay').textContent = maxTries;

            gameStartTime = new Date();
        }

        function renderBoard() {
            const container = document.getElementById('guessesContainer');
            
            // Only render if container is empty (first time) or we need to update current row
            if (container.children.length === 0) {
                // Create two columns for desktop, one for mobile
                const column1 = document.createElement('div');
                column1.className = 'guesses-column';
                column1.id = 'column-1';
                
                const column2 = document.createElement('div');
                column2.className = 'guesses-column';
                column2.id = 'column-2';
                
                // Determine rows per column based on maxTries
                const rowsPerColumn = Math.ceil(maxTries / 2);
                
                // Initial render
                for (let i = 0; i < maxTries; i++) {
                    const row = document.createElement('div');
                    row.className = 'guess-row';
                    row.id = `row-${i}`;
                    
                    // Add feedback on left for first column (Code Breaker mode)
                    if (gameMode === 'codebreaker' && i < rowsPerColumn) {
                        const feedbackLeft = document.createElement('div');
                        feedbackLeft.className = 'feedback feedback-left';
                        feedbackLeft.id = `feedback-${i}`;
                        row.appendChild(feedbackLeft);
                    }

                    const boxContainer = document.createElement('div');
                    boxContainer.style.display = 'flex';
                    boxContainer.style.gap = '5px';
                    
                    for (let j = 0; j < digitCount; j++) {
                        const box = document.createElement('div');
                        box.className = 'digit-box';
                        box.id = `box-${i}-${j}`;
                        boxContainer.appendChild(box);
                    }
                    
                    row.appendChild(boxContainer);
                    
                    // Add feedback div for Code Breaker mode
                    if (gameMode === 'codebreaker') {
                        const feedback = document.createElement('div');
                        feedback.className = 'feedback';
                        feedback.id = `feedback-${i}`;
                        row.appendChild(feedback);
                        document.body.style.zoom = 0.8;
                    }
                    
                    // Distribute rows between columns
                    if (i < rowsPerColumn) {
                        column1.appendChild(row);
                    } else {
                        column2.appendChild(row);
                    }
                }
                
                container.appendChild(column1);
                container.appendChild(column2);
            }

            // Update submitted guesses
            for (let i = 0; i < guesses.length; i++) {
                for (let j = 0; j < digitCount; j++) {
                    const box = document.getElementById(`box-${i}-${j}`);
                    if (box && !box.classList.contains('submitted')) {
                        box.textContent = guesses[i].guess[j];
                        box.classList.add('filled', 'submitted');
                        
                        if (gameMode === 'wordle') {
                            // Number Wordle: Show individual digit feedback
                            if (guesses[i].result[j] === 'correct') {
                                box.classList.add('correct', 'flip');
                            } else if (guesses[i].result[j] === 'present') {
                                box.classList.add('present', 'flip');
                            }
                        } else {
                            // Code Breaker: Just show the number, no colors
                            box.classList.add('codebreaker-filled');
                        }
                    }
                }
                
                // Update feedback for Code Breaker mode
                if (gameMode === 'codebreaker') {
                    const feedbackDiv = document.getElementById(`feedback-${i}`);
                    if (feedbackDiv && !feedbackDiv.hasChildNodes()) {
                        const correctCount = guesses[i].result.filter(r => r === 'correct').length;
                        const presentCount = guesses[i].result.filter(r => r === 'present').length;
                        
                        feedbackDiv.innerHTML = `
                            <span class="feedback-correct">‚úì ${correctCount}</span>
                            <span class="feedback-present">‚óê ${presentCount}</span>
                        `;
                    }
                }
            }

            // Update current guess row
            const currentRowIndex = guesses.length;
            if (currentRowIndex < maxTries) {
                for (let j = 0; j < digitCount; j++) {
                    const box = document.getElementById(`box-${currentRowIndex}-${j}`);
                    if (box) {
                        box.className = 'digit-box'; // Reset classes
                        
                        if (currentGuess[j]) {
                            box.textContent = currentGuess[j];
                            box.classList.add('filled');
                        } else {
                            box.textContent = '';
                            if (j === currentGuess.length) {
                                box.classList.add('active');
                            }
                        }
                    }
                }
            }
        }

        function checkGuess(guess) {
            const result = [];
            const targetDigits = targetNumber.split('');
            const guessDigits = guess.split('');
            const used = new Array(digitCount).fill(false);

            // First pass: mark correct positions
            for (let i = 0; i < digitCount; i++) {
                if (guessDigits[i] === targetDigits[i]) {
                    result[i] = 'correct';
                    used[i] = true;
                }
            }

            // Second pass: mark present digits
            for (let i = 0; i < digitCount; i++) {
                if (result[i] !== 'correct') {
                    let found = false;
                    for (let j = 0; j < digitCount; j++) {
                        if (!used[j] && guessDigits[i] === targetDigits[j] && i !== j) {
                            result[i] = 'present';
                            used[j] = true;
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        result[i] = 'absent';
                    }
                }
            }

            return result;
        }

        function submitGuess() {
            if (gameOver) return;

            const guess = currentGuess;

            if (guess.length !== digitCount) {
                document.getElementById('message').textContent = `Please enter exactly ${digitCount} digits`;
                return;
            }

            if (!allowRepeats) {
                const uniqueDigits = new Set(guess.split(''));
                if (uniqueDigits.size !== guess.length) {
                    document.getElementById('message').textContent = 'Repeated digits not allowed in this game';
                    return;
                }
            }

            const result = checkGuess(guess);
            guesses.push({ guess, result });
            allGuesses.push(guess); // Store the guess string
            currentGuess = '';
            
            renderBoard();
            updateStats();

            if (guess === targetNumber) {
                if (gameMode === "codebreaker"){
                    for (let j = 0; j < digitCount; j++) {
                            const box = document.getElementById(`box-${guesses.length-1}-${j}`);
                            box.classList.remove('codebreaker-filled')
                            box.classList.add('correct', 'flip');                            
                        }
                }
                gameOver = true;
                gameEndTime = new Date();
                timeElapsed = (gameEndTime - gameStartTime) / 1000; // in seconds
                gameScore = getScore(guesses.length, timeElapsed, digitCount, allowRepeats)
                
                document.getElementById('message').textContent = `üéâ Congratulations, you won! Game score = ${Math.round(gameScore*10)/10}`;
                addToHistory(true);
            } else if (guesses.length >= maxTries) {
                gameOver = true;
                document.getElementById('message').textContent = `Game Over! The number was ${targetNumber}`;
            } else {
                document.getElementById('message').textContent = '';
            }
        }

        function updateStats() {
            document.getElementById('triesCount').textContent = guesses.length;
        }

        function renderKeyboard() {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';

            // Number keys 0-9
            for (let i = 0; i <= 9; i++) {
                const key = document.createElement('button');
                key.className = 'key';
                key.textContent = i;
                key.onclick = () => handleKeyPress(i.toString());
                keyboard.appendChild(key);

                if (i === 4){
                    // Backspace key
                    const backspace = document.createElement('button');
                    backspace.className = 'key backspace';
                    backspace.textContent = 'DELETE';
                    backspace.onclick = () => handleBackspace();
                    keyboard.appendChild(backspace);
                }

            }

            // Enter key
            const enter = document.createElement('button');
            enter.className = 'key enter';
            enter.textContent = 'ENTER';
            enter.onclick = () => submitGuess();
            keyboard.appendChild(enter);
        }

        function handleKeyPress(digit) {
            if (gameOver || currentGuess.length >= digitCount) return;
            
            currentGuess += digit;
            renderBoard();
        }

        function handleBackspace() {
            if (gameOver || currentGuess.length === 0) return;
            
            currentGuess = currentGuess.slice(0, -1);
            renderBoard();
        }

        // Physical keyboard support
        document.addEventListener('keydown', function(e) {
            if (gameOver) return;

            if (e.key >= '0' && e.key <= '9') {
                handleKeyPress(e.key);
            } else if (e.key === 'Backspace') {
                // e.preventDefault();
                handleBackspace();
            } else if (e.key === 'Enter') {
                submitGuess();
            }
        });
        
        function showLeaderboard(mode) {
            const modal = document.getElementById('leaderboardModal');
            const title = document.getElementById('leaderboardTitle');
            const list = document.getElementById('leaderboardList');
            
            // Filter by game mode and sort by time
            const top10 = mode === 'wordle' ? topWordle : topCodeBreaker;
            const filtered = top10
                .filter(record => record.gameMode === mode && record.gameScore)
                .sort((a, b) => b.gameScore - a.gameScore)
                .slice(0, 10);
            
            title.textContent = mode === 'wordle' ? 'Top 10 Wordlers' : 'Top 10 CodeBreakers';

            if (filtered.length === 0) {
                list.innerHTML = '<div class="no-history">No completed games yet</div>';
            } else {
                list.innerHTML = '';
                filtered.forEach((record, index) => {
                    const minutes = Math.floor(record.timeElapsed / 60);
                    const seconds = Math.round(record.timeElapsed % 60);
                    const timeDisplay = `${minutes}m ${seconds}s`;
                    
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <div class="leaderboard-rank">#${index + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-player">${record.player}</div>
                            <div class="leaderboard-details">
                                ${record.time}, ${record.date} ‚Ä¢ ${record.attempts} attempts ‚Ä¢ ${record.digitCount} digits${record.allowRepeats ? ' (repeats)' : ''} ‚Ä¢ ${timeDisplay}
                            </div>
                        </div>
                        <div class="leaderboard-score">${record.gameScore.toFixed(1)}</div>
                    `;
                    list.appendChild(item);
                });
            }
            
            modal.style.display = 'flex';
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'none';
        }

        function showHelp() {
            document.getElementById('helpModal').style.display = 'flex';
        }

        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        // Show settings on load
        window.onload = function() {
            // Display version
            document.getElementById('versionText').textContent = gameVersion;

            document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("maxTriesDisplay").textContent = maxTries;
            });

            // Allow backspace/delete in modal inputs
            document.getElementById('playerName').addEventListener('keydown', function(e) {
                // Allow backspace and delete keys
                if (e.key === 'Backspace' || e.key === 'Delete') {
                    // Default behavior handles this
                    return;
                }
                // Allow Enter to start game
                if (e.key === 'Enter') {
                    startGame();
                }
            });

            loadHistory();
            showSettings();

            // Zoom control
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomValue = document.getElementById('zoomValue');
            const gameContainer = document.querySelector('.game-container');
            const historySection = document.querySelector('.history-section');

            zoomSlider.addEventListener('input', function() {
                const zoom = this.value / 100;
                zoomValue.textContent = this.value + '%';
                gameContainer.style.transform = `scale(${zoom})`;
                gameContainer.style.transformOrigin = 'top center';
                
                // Adjust history section position based on zoom
                const containerHeight = gameContainer.offsetHeight;
                const scaledHeight = containerHeight * zoom;
                const marginTop = scaledHeight - containerHeight + 30; // 30px extra spacing
                historySection.style.marginTop = marginTop + 'px';
            });

            // Escape key handler
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // Close settings modal if open and game is in progress
                    const settingsModal = document.getElementById('settingsModal');
                    if (settingsModal.style.display === 'flex' && guesses.length > 0) {
                        settingsModal.style.display = 'none';
                    }
                    
                    // Close leaderboard modal if open and game is in progress
                    const leaderboardModal = document.getElementById('leaderboardModal');
                    if (leaderboardModal.style.display === 'flex') {
                        leaderboardModal.style.display = 'none';
                    }

                    // Close help modal if open
                    const helpModal = document.getElementById('helpModal');
                    if (helpModal.style.display === 'flex') {
                        helpModal.style.display = 'none';
                    }
                }
            });
        };
    </script>

    <div id="leaderboardModal" class="leaderboard-modal">
        <div class="leaderboard-content">
            <h2 id="leaderboardTitle">Top 10</h2>
            <div class="leaderboard-list" id="leaderboardList"></div>
            <button class="close-leaderboard" onclick="closeLeaderboard()">Close</button>
        </div>
    </div>

    <div id="helpModal" class="help-modal">
        <div class="help-content">
            <h2>How To Play</h2>
            <p>Guess the hidden number in 10 tries or less!</p>
            
            <h3>Number Wordle</h3>
            <p>After each guess, the color of the tiles will change to show how close your guess was to the number.</p>
            
            <p><strong>Green</strong> means the digit is in the number and in the correct spot.</p>

            <div class="help-example">
                <div class="help-box correct">1</div>
                <div class="help-box">2</div>
                <div class="help-box">3</div>
                <div class="help-box">4</div>
            </div>
            
            <p><strong>Yellow</strong> means the digit is in the number but in the wrong spot.</p>
            <div class="help-example">
                <div class="help-box">5</div>
                <div class="help-box present">6</div>
                <div class="help-box">7</div>
                <div class="help-box">8</div>
            </div>
            
            <p><strong>Gray</strong> means the digit is not in the number at all.</p>
            <div class="help-example">
                <div class="help-box">9</div>
                <div class="help-box">0</div>
                <div class="help-box absent">1</div>
                <div class="help-box">2</div>
            </div>
            
            <h3>Code Breaker</h3>
            <p>A harder mode! Instead of showing which specific digits are correct, you only see:</p>
            <p><strong>‚úì</strong> - Number of digits in the correct position<br>
            <strong>‚óê</strong> - Number of correct digits in wrong positions</p>
            <p>Use logic and deduction to figure out which digits go where!</p>

            <h3>Scoring System</h3>
            <ul>
                <li>Fewer tries and faster solving time translate to higher game score.</li>
                <li>Longer numbers and repeating digits options have higher scoring cap.</li>
            </ul>
            
            <button class="close-help" onclick="closeHelp()">Got It!</button>
        </div>
    </div>
</body>
</html>